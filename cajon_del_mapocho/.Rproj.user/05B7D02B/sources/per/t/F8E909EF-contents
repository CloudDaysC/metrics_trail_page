---
title: "Cajon del Mapocho"
author: "Raimundo Sánchez"
output: html_document
---

El rio Mapocho sin duda es un icono de la geografia Santiaguina, donde sus aguas han dado forma a nuestra ciudad desde que los incas y picunches habitaban el valle central de Chile. 

Sus aguas nacen desde la base del Cerro el Plomo, o Apu Wamani, protector de este valle del Mapocho, el cual ha sido visitado por los habitantes de esta zona desde tiempos inmemoriales. 

El cajon del Rio Mapocho ha forjado por lo tanto la cultura de montaña de nuestra capital, presentando diversos hitos geograficos e historicos que se encuentran a lo largo de su extension. 

La ruta el Cajon del Mapocho recorre algunos de estos hitos, conectando en un ciclo cerrado diversos senderos que permiten hacerse una buena idea de la grandeza y crudeza de la montaña que rodea a Santiago de Chile. 


## Hitos de la ruta

### Puente Ñilhue (Km 0 - Km 87)

La ruta comienza y termina en el puente Ñilhue, clasico acceso a la cordillera desde donde se puede subir al cerro San Ramon, Provincia, Ñipa, Alto del Naranjo entre otros. Este acceso a la cordillera ha servido de lugar de iniciacion en el montañismo a diversas generaciones de Santiaguinos, y hacia el norte permite subir el Cerro Pochoco, otro clasico Santiaguino. 

### Corral Llanos de Javier (Km 9.5)

El primer tramo lleva desde puente Ñilhue hacia el cerro Pochoco, para seguir a la loma de la vaca y llegar finalmente al corral Llanos de Javier. Este lugar obtiene su nombre de la geografica, que corresponde a una planicie en medio de la montaÃ±a, la cual se eleva por sobre los 1840 msnm, y conecta senderos provenientes desde el Pochoco, del Santuario de la Naturaleza del Arrayan, y desde Los Maitenes. 

### Corral Quemado (Km 22)

El segundo tramo sube desde Llanos de Javier hasta los Maitentes y desiende 1km por el camino vehicular hasta Corral Quemado. En este punto se bifurca el camino a los Centros de Ski y el camino a la Mina La Disputada. Este punto formaba parte del sistema de caminos incaicos y se dice que fue un importante punto de relevo para las ceremonias que se realizaban en la cumbre del Cerro El Plomo.

### La Parva (Km 33.5)

La ruta sigue hacia la Parva, centro de Ski que se encuentra en las laderas del Cerro que lleva el mismo nombre. En este centro de Ski recibe visitantes todo el invierno, pero en el verano tambien, siendo un lugar frecuentado por montañistas que se aventuran a hacer cumbres como el Cerro Pintor, Leonera, o el Plomo. 

### Cancha de Carreras (Km 42)

### Campamento Federacion (Km 45.5)

### Piedra numerada (Km 51)

### Refugio del Cepo (Km 63.5)

### La Ermita (Km 81.5)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(GPStream)
library(sp)
library(leaflet)
library(tidyverse)

ruta_strm <- 
  read_stream_file("cajon_del_mapocho.gpx") %>% 
  rename_stream() %>% 
  differential_stream() 


ruta_sp <- SpatialPointsDataFrame(data=ruta_strm, 
                                  coords = ruta_strm[,c("lon","lat")], 
                                  proj4string=CRS("+proj=longlat +datum=WGS84"))


PCS <- c(9.65, 22.05, 33.35, 42.05, 45.7, 50.82, 63.5, 81.55, 87.7)

tramo1 <- ruta_strm %>% filter(distance <= PCS[1]) 
tramo2 <- ruta_strm %>% filter(distance > PCS[1] & distance <= PCS[2])
tramo3 <- ruta_strm %>% filter(distance > PCS[2] & distance <= PCS[3])
tramo4 <- ruta_strm %>% filter(distance > PCS[3] & distance <= PCS[4])
tramo5 <- ruta_strm %>% filter(distance > PCS[4] & distance <= PCS[5])
tramo6 <- ruta_strm %>% filter(distance > PCS[5] & distance <= PCS[6])
tramo7 <- ruta_strm %>% filter(distance > PCS[6] & distance <= PCS[7])
tramo8 <- ruta_strm %>% filter(distance > PCS[7] & distance <= PCS[8])
tramo9 <- ruta_strm %>% filter(distance > PCS[8] & distance <= PCS[9])

tabla <- data.frame( "Tramo" = c("Tramo 1","Tramo 2","Tramo 3","Tramo 4","Tramo 5","Tramo 6","Tramo 7","Tramo 8","Tramo 9","Total"),
                     "Distancia" = c(sum(tramo1$delta_distance),
                                     sum(tramo2$delta_distance),
                                     sum(tramo3$delta_distance),
                                     sum(tramo4$delta_distance),
                                     sum(tramo5$delta_distance),
                                     sum(tramo6$delta_distance),
                                     sum(tramo7$delta_distance),
                                     sum(tramo8$delta_distance),
                                     sum(tramo9$delta_distance),
                                     sum(ruta_strm$delta_distance)),
                      "ElevGain" =  c(sum(tramo1$dplus),
                                      sum(tramo2$dplus),
                                      sum(tramo3$dplus),
                                      sum(tramo4$dplus),
                                      sum(tramo5$dplus),
                                      sum(tramo6$dplus),
                                      sum(tramo7$dplus),
                                      sum(tramo8$dplus),
                                      sum(tramo9$dplus),
                                      sum(ruta_strm$dplus)))

hitos <- data.frame(rbind(c(tramo1[1,c("lon","lat","ele")], "Puente Ãilhue"),
                          c(tramo2[1,c("lon","lat","ele")], "Llanos de Javier"),
                          c(tramo3[1,c("lon","lat","ele")], "Corral quemado"),
                          c(tramo4[1,c("lon","lat","ele")], "La Parva"),
                          c(tramo5[1,c("lon","lat","ele")], "Cancha de carreras"),
                          c(tramo6[1,c("lon","lat","ele")], "Federacion"),
                          c(tramo7[1,c("lon","lat","ele")], "Piedra numerada"),
                          c(tramo8[1,c("lon","lat","ele")], "Refugio del Cepo"),
                          c(tramo9[1,c("lon","lat","ele")], "La Ermita")))
       
hitos$lat <- as.numeric(hitos$lat)
hitos$lon <- as.numeric(hitos$lon)

hitossp <- SpatialPointsDataFrame(data=hitos, coords = hitos[,1:2], proj4string=CRS("+proj=longlat +datum=WGS84"))

tramo1sp <- tramo1 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo2sp <- tramo2 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo3sp <- tramo3 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo4sp <- tramo4 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo5sp <- tramo5 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo6sp <- tramo6 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo7sp <- tramo7 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo8sp <- tramo8 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))
tramo9sp <- tramo9 %>% select(lon,lat) %>% 
  SpatialPointsDataFrame( data = ., coords = .,proj4string=CRS("+proj=longlat +datum=WGS84"))





leaflet(width = '100%') %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addProviderTiles(providers$OpenTopoMap) %>% ## uso mapa topografico
  addCircleMarkers(data = tramo1sp, radius = 1, col = topo.colors(9)[9], group="Tramo 1") %>% 
  addCircleMarkers(data = tramo2sp, radius = 1, col = topo.colors(9)[2], group="Tramo 2") %>% 
  addCircleMarkers(data = tramo3sp, radius = 1, col = topo.colors(9)[7], group="Tramo 3") %>% 
  addCircleMarkers(data = tramo4sp, radius = 1, col = topo.colors(9)[4], group="Tramo 4") %>% 
  addCircleMarkers(data = tramo5sp, radius = 1, col = topo.colors(9)[6], group="Tramo 5") %>% 
  addCircleMarkers(data = tramo6sp, radius = 1, col = topo.colors(9)[5], group="Tramo 6") %>% 
  addCircleMarkers(data = tramo7sp, radius = 1, col = topo.colors(9)[3], group="Tramo 7") %>% 
  addCircleMarkers(data = tramo8sp, radius = 1, col = topo.colors(9)[8], group="Tramo 8") %>% 
  addCircleMarkers(data = tramo9sp, radius = 1, col = topo.colors(9)[1], group="Tramo 9") %>% 
  addCircleMarkers(data = hitossp, radius = 5, col = "red", popup = hitossp$V4) %>% 
  addLayersControl(
          overlayGroups =c("Tramo 1", "Tramo 2", "Tramo 3", "Tramo 4", "Tramo 5", "Tramo 6", "Tramo 7", "Tramo 8", "Tramo 9"),
          options = layersControlOptions(collapsed=TRUE)
          ) 

```


## [GPX de la ruta](./cajon_del_mapocho.gpx) 
### Distancia total:        87 km
### Desnivel positivo:    5000 m

### incluir tabla de distancias, desnivel, hitos, etc
### incluir grafico de desnivel de la ruta con cada hito
```{r, echo=FALSE}
ggplot(ruta_strm, aes(distance, ele)) + 
  geom_line() + 
  geom_vline(xintercept = PCS) +
  ylab("ElevaciÃ³n (msnm)") + 
  xlab("Distancia") +
  theme_minimal()
```


Y las distancias y desnivel ganado en cada ruta estan en la siguiente tabla

```{r, echo=FALSE}

print(tabla)
```
